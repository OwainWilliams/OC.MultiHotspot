{"version":3,"file":"key-sequence.condition-CRSZu0uA.js","sources":["../../../Client/src/conditions/key-sequence.service.ts","../../../Client/src/conditions/key-sequence.condition.ts"],"sourcesContent":["import { UmbControllerBase } from \"@umbraco-cms/backoffice/class-api\";\r\nimport { UmbControllerHost } from \"@umbraco-cms/backoffice/controller-api\";\r\nimport { getHiddenDashboardConfig } from \"../config/config.service.js\";\r\n\r\nexport class KeySequenceService extends UmbControllerBase {\r\n  private _keySequence: string[] = [];\r\n  private _targetSequence: string[] = [];\r\n  private _isActivated = false;\r\n  private _timeoutId?: number;\r\n  private _isEnabled = false;\r\n\r\n  constructor(host: UmbControllerHost) {\r\n    super(host);\r\n    this.#loadConfigAndSetup(host);\r\n  }\r\n\r\n  async #loadConfigAndSetup(host: UmbControllerHost) {\r\n    // Get the configuration service\r\n    const configService = getHiddenDashboardConfig(host);\r\n\r\n    console.log(\"KeySequenceService: Waiting for config...\");\r\n\r\n    // Wait for config to load - but don't block the constructor\r\n    configService.config.subscribe((config) => {\r\n      console.log(\"KeySequenceService: Config received\", config);\r\n\r\n      if (config.keySequence && config.keySequence.length > 0) {\r\n        this._targetSequence = config.keySequence;\r\n        this._isEnabled = true;\r\n        console.log(\r\n          \"KeySequenceService: Key sequence configured\",\r\n          this._targetSequence\r\n        );\r\n\r\n        // Only setup listener once\r\n        if (!document.querySelector('[data-key-sequence-listener]')) {\r\n          this.#setupKeyListener();\r\n        }\r\n      } else {\r\n        // No key sequence configured, dashboard remains disabled\r\n        this._isEnabled = false;\r\n        console.log(\r\n          \"KeySequenceService: No key sequence configured, dashboard disabled\"\r\n        );\r\n      }\r\n    });\r\n  }\r\n\r\n  #setupKeyListener() {\r\n    // Mark that we've set up the listener\r\n    document.body.setAttribute(\"data-key-sequence-listener\", \"true\");\r\n    document.addEventListener(\"keydown\", this.#handleKeyPress);\r\n    console.log(\"KeySequenceService: Key listener setup complete\");\r\n  }\r\n\r\n  #handleKeyPress = (event: KeyboardEvent) => {\r\n    if (!this._isEnabled) {\r\n      return;\r\n    }\r\n\r\n    // Clear timeout if exists\r\n    if (this._timeoutId) {\r\n      window.clearTimeout(this._timeoutId);\r\n    }\r\n\r\n    // Add the key to sequence\r\n    this._keySequence.push(event.key);\r\n\r\n    console.log(\r\n      \"Key pressed:\",\r\n      event.key,\r\n      \"Current sequence:\",\r\n      [...this._keySequence],\r\n      \"Target:\",\r\n      this._targetSequence\r\n    );\r\n\r\n    // Keep only the last N keys where N is the target sequence length\r\n    if (this._keySequence.length > this._targetSequence.length) {\r\n      this._keySequence.shift();\r\n    }\r\n\r\n    // Check if sequence matches\r\n    if (this.#checkSequence()) {\r\n      this._isActivated = true;\r\n      this.#notifyChange();\r\n      console.log(\"ðŸŽ® Secret dashboard unlocked!\");\r\n    }\r\n\r\n    // Reset sequence after 2 seconds of inactivity\r\n    this._timeoutId = window.setTimeout(() => {\r\n      this._keySequence = [];\r\n      console.log(\"Key sequence reset due to inactivity\");\r\n    }, 2000);\r\n  };\r\n\r\n  #checkSequence(): boolean {\r\n    if (this._keySequence.length !== this._targetSequence.length) {\r\n      return false;\r\n    }\r\n\r\n    return this._targetSequence.every(\r\n      (key, index) => key === this._keySequence[index]\r\n    );\r\n  }\r\n\r\n  #notifyChange() {\r\n    // Dispatch a custom event to notify condition checkers\r\n    window.dispatchEvent(new CustomEvent(\"key-sequence-activated\"));\r\n  }\r\n\r\n  isActivated(): boolean {\r\n    return this._isActivated;\r\n  }\r\n\r\n  override destroy(): void {\r\n    super.destroy();\r\n    document.removeEventListener(\"keydown\", this.#handleKeyPress);\r\n    document.body.removeAttribute(\"data-key-sequence-listener\");\r\n    if (this._timeoutId) {\r\n      window.clearTimeout(this._timeoutId);\r\n    }\r\n  }\r\n}\r\n\r\n// Singleton instance\r\nlet instance: KeySequenceService | null = null;\r\n\r\nexport function getKeySequenceService(host: UmbControllerHost): KeySequenceService {\r\n  if (!instance) {\r\n    instance = new KeySequenceService(host);\r\n  }\r\n  return instance;\r\n}\r\n","import {\r\n  type UmbConditionConfigBase,\r\n  type UmbConditionControllerArguments,\r\n  type UmbExtensionCondition,\r\n} from \"@umbraco-cms/backoffice/extension-api\";\r\nimport { UmbConditionBase } from \"@umbraco-cms/backoffice/extension-registry\";\r\nimport type { UmbControllerHost } from \"@umbraco-cms/backoffice/controller-api\";\r\nimport { getKeySequenceService } from \"./key-sequence.service.js\";\r\n\r\nexport type KeySequenceConditionConfig = UmbConditionConfigBase<\"OC.Condition.KeySequence\">;\r\n\r\nexport class KeySequenceCondition\r\n  extends UmbConditionBase<KeySequenceConditionConfig>\r\n  implements UmbExtensionCondition\r\n{\r\n  #handleActivation: () => void;\r\n\r\n  constructor(\r\n    host: UmbControllerHost,\r\n    args: UmbConditionControllerArguments<KeySequenceConditionConfig>\r\n  ) {\r\n    super(host, args);\r\n\r\n    // Initialize the service\r\n    const service = getKeySequenceService(host);\r\n    \r\n    // Set initial state\r\n    this.permitted = service.isActivated();\r\n\r\n    // Listen for activation events\r\n    this.#handleActivation = () => {\r\n      this.permitted = service.isActivated();\r\n    };\r\n\r\n    window.addEventListener(\"key-sequence-activated\", this.#handleActivation);\r\n  }\r\n\r\n  override destroy(): void {\r\n    window.removeEventListener(\"key-sequence-activated\", this.#handleActivation);\r\n    super.destroy();\r\n  }\r\n}\r\n\r\nexport default KeySequenceCondition;\r\n"],"names":["KeySequenceService","UmbControllerBase","host","#handleKeyPress","event","#checkSequence","#notifyChange","#loadConfigAndSetup","configService","getHiddenDashboardConfig","config","#setupKeyListener","key","index","instance","getKeySequenceService","KeySequenceCondition","UmbConditionBase","#handleActivation","args","service"],"mappings":";;;AAIO,MAAMA,UAA2BC,EAAkB;AAAA,EAOxD,YAAYC,GAAyB;AACnC,UAAMA,CAAI,GAPZ,KAAQ,eAAyB,CAAA,GACjC,KAAQ,kBAA4B,CAAA,GACpC,KAAQ,eAAe,IAEvB,KAAQ,aAAa,IA8CrB,KAAAC,KAAkB,CAACC,MAAyB;AAC1C,MAAK,KAAK,eAKN,KAAK,cACP,OAAO,aAAa,KAAK,UAAU,GAIrC,KAAK,aAAa,KAAKA,EAAM,GAAG,GAEhC,QAAQ;AAAA,QACN;AAAA,QACAA,EAAM;AAAA,QACN;AAAA,QACA,CAAC,GAAG,KAAK,YAAY;AAAA,QACrB;AAAA,QACA,KAAK;AAAA,MAAA,GAIH,KAAK,aAAa,SAAS,KAAK,gBAAgB,UAClD,KAAK,aAAa,MAAA,GAIhB,KAAKC,SACP,KAAK,eAAe,IACpB,KAAKC,GAAA,GACL,QAAQ,IAAI,+BAA+B,IAI7C,KAAK,aAAa,OAAO,WAAW,MAAM;AACxC,aAAK,eAAe,CAAA,GACpB,QAAQ,IAAI,sCAAsC;AAAA,MACpD,GAAG,GAAI;AAAA,IACT,GAjFE,KAAKC,GAAoBL,CAAI;AAAA,EAC/B;AAAA,EAEA,MAAMK,GAAoBL,GAAyB;AAEjD,UAAMM,IAAgBC,EAAyBP,CAAI;AAEnD,YAAQ,IAAI,2CAA2C,GAGvDM,EAAc,OAAO,UAAU,CAACE,MAAW;AACzC,cAAQ,IAAI,uCAAuCA,CAAM,GAErDA,EAAO,eAAeA,EAAO,YAAY,SAAS,KACpD,KAAK,kBAAkBA,EAAO,aAC9B,KAAK,aAAa,IAClB,QAAQ;AAAA,QACN;AAAA,QACA,KAAK;AAAA,MAAA,GAIF,SAAS,cAAc,8BAA8B,KACxD,KAAKC,GAAA,MAIP,KAAK,aAAa,IAClB,QAAQ;AAAA,QACN;AAAA,MAAA;AAAA,IAGN,CAAC;AAAA,EACH;AAAA,EAEAA,KAAoB;AAElB,aAAS,KAAK,aAAa,8BAA8B,MAAM,GAC/D,SAAS,iBAAiB,WAAW,KAAKR,EAAe,GACzD,QAAQ,IAAI,iDAAiD;AAAA,EAC/D;AAAA,EAEAA;AAAA,EAyCAE,KAA0B;AACxB,WAAI,KAAK,aAAa,WAAW,KAAK,gBAAgB,SAC7C,KAGF,KAAK,gBAAgB;AAAA,MAC1B,CAACO,GAAKC,MAAUD,MAAQ,KAAK,aAAaC,CAAK;AAAA,IAAA;AAAA,EAEnD;AAAA,EAEAP,KAAgB;AAEd,WAAO,cAAc,IAAI,YAAY,wBAAwB,CAAC;AAAA,EAChE;AAAA,EAEA,cAAuB;AACrB,WAAO,KAAK;AAAA,EACd;AAAA,EAES,UAAgB;AACvB,UAAM,QAAA,GACN,SAAS,oBAAoB,WAAW,KAAKH,EAAe,GAC5D,SAAS,KAAK,gBAAgB,4BAA4B,GACtD,KAAK,cACP,OAAO,aAAa,KAAK,UAAU;AAAA,EAEvC;AACF;AAGA,IAAIW,IAAsC;AAEnC,SAASC,EAAsBb,GAA6C;AACjF,SAAKY,MACHA,IAAW,IAAId,EAAmBE,CAAI,IAEjCY;AACT;AC1HO,MAAME,UACHC,EAEV;AAAA,EACEC;AAAA,EAEA,YACEhB,GACAiB,GACA;AACA,UAAMjB,GAAMiB,CAAI;AAGhB,UAAMC,IAAUL,EAAsBb,CAAI;AAG1C,SAAK,YAAYkB,EAAQ,YAAA,GAGzB,KAAKF,KAAoB,MAAM;AAC7B,WAAK,YAAYE,EAAQ,YAAA;AAAA,IAC3B,GAEA,OAAO,iBAAiB,0BAA0B,KAAKF,EAAiB;AAAA,EAC1E;AAAA,EAES,UAAgB;AACvB,WAAO,oBAAoB,0BAA0B,KAAKA,EAAiB,GAC3E,MAAM,QAAA;AAAA,EACR;AACF;"}